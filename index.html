<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unscramble the Campus: Teacher's Day Challenge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #0f172a;
            background: linear-gradient(135deg, #1e293b, #0f172a, #334155, #1e293b);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            touch-action: manipulation;
            overflow-x: hidden;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Animations for Setup Screen --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px 10px rgba(34, 197, 94, 0); }
        }
        .animate-fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }
        #start-game-button { animation: pulse 2.5s infinite; }
        .delay-1 { animation-delay: 0.2s; }
        .delay-2 { animation-delay: 0.4s; }
        .delay-3 { animation-delay: 0.6s; }
        .delay-4 { animation-delay: 0.8s; }
        .delay-5 { animation-delay: 1.0s; }


        /* Responsive tile and font sizes */
        .letter-tile, .drop-zone {
            width: 3rem; height: 3rem; font-size: 1.25rem;
            display: flex; align-items: center; justify-content: center;
            border-radius: 0.5rem; user-select: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @media (min-width: 640px) {
            .letter-tile, .drop-zone { width: 4rem; height: 4rem; font-size: 1.75rem; border-radius: 0.75rem;}
        }
        @media (min-width: 1024px) {
            .letter-tile, .drop-zone { width: 5rem; height: 5rem; font-size: 2.25rem; }
        }
        
        /* NEW Tile Styling */
        .letter-tile {
            background: linear-gradient(145deg, #e6e6e6, #ffffff);
            color: #1e293b;
            text-shadow: 1px 1px 1px #ffffff;
            box-shadow: 0 5px 8px rgba(0,0,0,0.15), 0 2px 3px rgba(0,0,0,0.1), inset 0 2px 1px #ffffff;
            font-weight: 700; cursor: pointer;
        }
        .letter-tile:active { 
            transform: scale(0.95) translateY(2px); 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), inset 0 2px 1px #ffffff;
        }
        .drop-zone {
            background-color: rgba(0, 0, 0, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.15);
        }
        .dragging {
            opacity: 0.6; transform: scale(1.1) rotate(4deg);
            box-shadow: 0 10px 15px rgba(0,0,0,0.2); cursor: grabbing;
        }
        .drag-over {
            background-color: rgba(165, 180, 252, 0.25); border-style: solid; transform: scale(1.05);
            border-color: rgba(165, 180, 252, 0.8);
        }
        .correct {
            background: linear-gradient(145deg, #22c55e, #16a34a) !important; 
            color: white !important; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            animation: bounce 0.5s;
            border-color: #16a34a;
        }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }

        .shake { animation: shake-horizontal 0.5s cubic-bezier(0.455, 0.030, 0.515, 0.955) both; }
        @keyframes shake-horizontal {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }

        .confetti {
            position: fixed; top: -20px;
            width: 10px; height: 20px;
            opacity: 0.9; z-index: 9999;
            pointer-events: none;
            animation: fall 5s linear infinite;
        }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); opacity: 0; } }
        
        .screen { transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; }
        .hidden { opacity: 0; transform: scale(0.95); pointer-events: none; position: absolute; }
        
        .input-field {
            background-color: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
            color: white; border-radius: 0.5rem; transition: all 0.2s;
        }
        .input-field:focus { background-color: rgba(255,255,255,0.1); border-color: #a78bfa; ring: 0; }
        ::placeholder { color: rgba(255,255,255,0.4); }
        
        .team-a-active { border-color: #22c55e; box-shadow: 0 0 25px rgba(34, 197, 94, 0.5); }
        .team-b-active { border-color: #3b82f6; box-shadow: 0 0 25px rgba(59, 130, 246, 0.5); }
        
        .player-list { max-height: 150px; overflow-y: auto; padding-right: 0.5rem; }
        .player-list::-webkit-scrollbar { width: 8px; }
        .player-list::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        .player-list::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        .player-list::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.4); }
        
        .disabled\:opacity-50 { cursor: not-allowed; }

        /* NEW Bottom box styling */
        #tiles-container {
            background-color: rgba(0,0,0,0.25);
            box-shadow: inset 0 4px 10px rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.05);
            background-image: linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 25px 25px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center text-white p-2 sm:p-4 overflow-y-auto">

    <div id="game-container" class="w-full max-w-7xl mx-auto text-center relative">

        <!-- Setup Screen -->
        <div id="setup-screen" class="screen w-full">
            <h1 class="text-4xl sm:text-5xl md:text-7xl font-bold mb-2 opacity-0 animate-fade-in-up">Unscramble the Campus</h1>
            <p class="text-lg sm:text-xl md:text-2xl mb-2 text-yellow-300 opacity-0 animate-fade-in-up delay-1">Happy Teacher's Day!</p>
            <p class="text-sm sm:text-base md:text-lg mb-8 text-slate-300 opacity-0 animate-fade-in-up delay-2">A game by the F.Y. M.Sc. Environment Science Students</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 text-left">
                <div class="bg-black/20 p-6 rounded-xl border border-white/10 opacity-0 animate-fade-in-up delay-3">
                    <h2 class="text-3xl font-bold mb-4 text-green-400">Team A (Evergreens)</h2>
                    <input type="text" id="team-a-name" placeholder="Enter Team A Name" class="w-full p-3 mb-4 text-lg input-field" value="Titans">
                    <div id="team-a-players" class="space-y-2 mb-4 player-list">
                        <input type="text" placeholder="Professor 1 Name" class="w-full p-2 input-field player-input-a">
                    </div>
                    <button onclick="addPlayer('a')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">Add Player</button>
                </div>
                <div class="bg-black/20 p-6 rounded-xl border border-white/10 opacity-0 animate-fade-in-up delay-4">
                    <h2 class="text-3xl font-bold mb-4 text-blue-400">Team B (Aquas)</h2>
                    <input type="text" id="team-b-name" placeholder="Enter Team B Name" class="w-full p-3 mb-4 text-lg input-field" value="Warriors">
                     <div id="team-b-players" class="space-y-2 mb-4 player-list">
                        <input type="text" placeholder="Professor 1 Name" class="w-full p-2 input-field player-input-b">
                    </div>
                    <button onclick="addPlayer('b')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-transform hover:scale-105">Add Player</button>
                </div>
            </div>
            <button id="start-game-button" class="mt-8 bg-gradient-to-br from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 px-8 rounded-full text-xl sm:text-2xl shadow-lg shadow-green-500/30 transform transition-transform duration-200 hover:scale-105 animate-fade-in-up delay-5">
                START CHALLENGE
            </button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen hidden w-full">
            <div id="progress-bar-container" class="w-full bg-black/20 rounded-full h-4 mb-4 mx-auto max-w-2xl">
                <div id="progress-bar" class="bg-violet-500 h-4 rounded-full transition-all duration-500"></div>
            </div>
            <div id="turn-indicator" class="mb-4 transition-all duration-500">
                <h2 id="current-player-turn" class="text-3xl sm:text-4xl font-bold"></h2>
                <p class="text-base sm:text-lg text-slate-300">Unscramble the building name!</p>
            </div>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div id="team-a-score-display" class="bg-black/20 p-4 rounded-lg w-full md:w-1/3 transition-all duration-500 border-2 border-transparent">
                    <h3 id="team-a-score-name" class="text-xl sm:text-2xl font-bold text-green-400"></h3>
                    <p id="team-a-score" class="text-3xl sm:text-4xl font-bold">0</p>
                </div>
                <div id="timer" class="text-4xl sm:text-5xl font-bold bg-white/10 px-6 py-3 rounded-lg order-first md:order-none">02:00</div>
                <div id="team-b-score-display" class="bg-black/20 p-4 rounded-lg w-full md:w-1/3 transition-all duration-500 border-2 border-transparent">
                    <h3 id="team-b-score-name" class="text-xl sm:text-2xl font-bold text-blue-400"></h3>
                    <p id="team-b-score" class="text-3xl sm:text-4xl font-bold">0</p>
                </div>
            </div>

            <div id="answer-container" class="flex flex-wrap gap-1 sm:gap-2 justify-center mb-6 sm:mb-8 min-h-[4rem] sm:min-h-[5rem] md:min-h-[7rem]"></div>
            <div id="tiles-container" class="flex flex-wrap gap-1 sm:gap-2 justify-center p-2 sm:p-4 rounded-xl min-h-[4rem] sm:min-h-[5rem] md:min-h-[7rem]"></div>
            
            <div class="mt-8 sm:mt-12 flex justify-center gap-4 sm:gap-6">
                <button id="hint-button" class="bg-gradient-to-br from-purple-600 to-indigo-700 hover:from-purple-700 hover:to-indigo-800 text-white font-bold py-3 px-4 sm:px-6 rounded-full text-base sm:text-lg shadow-lg shadow-purple-600/30 transform transition hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                    Hint (-5 Pts & -15s)
                </button>
                <button id="skip-button" class="bg-gradient-to-br from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold py-3 px-4 sm:px-6 rounded-full text-base sm:text-lg shadow-lg shadow-orange-500/30 transform transition hover:scale-105">
                    Give Up
                </button>
            </div>
        </div>

        <!-- End Screen -->
        <div id="end-screen" class="screen hidden">
             <div class="bg-black/20 border-2 border-yellow-400 rounded-2xl p-6 sm:p-12 max-w-4xl mx-auto shadow-2xl shadow-yellow-400/10">
                <div class="trophy-icon text-yellow-400 mb-4">
                     <svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 sm:w-32 sm:h-32 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                </div>
                <h1 id="winner-announcement" class="text-4xl sm:text-6xl font-bold mb-2"></h1>
                <p class="text-xl sm:text-2xl mb-4 text-yellow-300">Happy Teacher's Day!</p>
                <p class="text-lg sm:text-xl mb-8 text-slate-300">Thank you for being amazing mentors.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 text-left">
                    <div class="bg-green-900/50 p-6 rounded-lg">
                        <h2 id="final-team-a-name" class="text-2xl sm:text-3xl font-bold mb-4 text-green-400"></h2>
                        <p id="final-team-a-score" class="text-5xl sm:text-6xl font-bold mb-6"></p>
                        <h3 class="font-bold text-lg mb-2 text-slate-300">Players:</h3>
                        <ul id="final-team-a-players" class="flex flex-wrap justify-start gap-2"></ul>
                    </div>
                     <div class="bg-blue-900/50 p-6 rounded-lg">
                        <h2 id="final-team-b-name" class="text-2xl sm:text-3xl font-bold mb-4 text-blue-400"></h2>
                        <p id="final-team-b-score" class="text-5xl sm:text-6xl font-bold mb-6"></p>
                        <h3 class="font-bold text-lg mb-2 text-slate-300">Players:</h3>
                        <ul id="final-team-b-players" class="flex flex-wrap justify-start gap-2"></ul>
                    </div>
                </div>
                <button id="play-again-button" class="mt-8 bg-yellow-400 text-gray-800 font-bold py-3 sm:py-4 px-6 sm:px-8 rounded-full text-lg sm:text-2xl shadow-lg transform hover:scale-105">Play Again</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <script>
        // --- DOM Elements ---
        const setupScreen = document.getElementById('setup-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startGameButton = document.getElementById('start-game-button');
        const playAgainButton = document.getElementById('play-again-button');
        const tilesContainer = document.getElementById('tiles-container');
        const answerContainer = document.getElementById('answer-container');
        const timerDisplay = document.getElementById('timer');
        const hintButton = document.getElementById('hint-button');
        const skipButton = document.getElementById('skip-button');
        const progressBar = document.getElementById('progress-bar');

        // --- Game Data & State ---
        const buildingNames = [
            'Vishwakarma', 'Saraswati', 'Ganga', 'Abraham', 'Agastya', 'Nanak', 'Dhanwantri', 
            'Dnyaneshwara', 'Awanti', 'Atri', 'Vashishta', 'Bharatwaj', 'Dronacharya', 'Jamdagini', 
            'Vyas', 'Kabir', 'Mahaveer', 'Prayag', 'Dhruv', 'Gautam', 'Aaryabhata', 'Gargi', 'Kashyap', 
            'Vishwamitra', 'Maitreye', 'Chanakya', 'Aryabhatt', 'WPU', 'Vivekananda'
        ];
        const BASE_TIME = 30; const TIME_PER_LETTER = 4;
        const HINT_COST = 5; const HINT_TIME_PENALTY = 15;
        
        let words = []; let currentWordIndex = 0; let currentWord = '';
        let timerInterval; let timeLeft; let draggedTile = null;
        let teams = { a: { name: '', players: [], score: 0 }, b: { name: '', players: [], score: 0 } };
        let currentTeamKey = 'a';

        // --- Sound Effects ---
        let successSound, snapSound, errorSound, winSound, passSound;
        
        function setupSounds() {
            if (typeof Tone === 'undefined' || (Tone.context && Tone.context.state === 'running')) return;
            Tone.start();
            successSound = new Tone.Synth({ oscillator: { type: 'sine' } }).toDestination();
            snapSound = new Tone.Synth({ oscillator: { type: 'triangle' }, volume: -12 }).toDestination();
            errorSound = new Tone.Synth({ oscillator: { type: 'square' }, envelope: { attack: 0.01, decay: 0.3 } }).toDestination();
            passSound = new Tone.Synth({ oscillator: { type: 'sawtooth' }, volume: -8 }).toDestination();
            winSound = new Tone.PolySynth(Tone.Synth).toDestination();
        }

        const shuffleString = s => { let a=s.split(''), n=a.length; for(let i=n-1; i>0; i--){ let j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } const sh=a.join(''); return sh===s?shuffleString(s):sh; };
        const shuffleArray = a => { for(let i=a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; };

        function switchScreen(fromEl, toEl) {
            fromEl.classList.add('hidden');
            if (toEl.id === 'setup-screen') {
                const animatedElements = toEl.querySelectorAll('.animate-fade-in-up');
                animatedElements.forEach(el => {
                    el.classList.remove('animate-fade-in-up');
                    void el.offsetWidth; 
                    el.classList.add('animate-fade-in-up');
                });
            }
            toEl.classList.remove('hidden');
        }

        function addPlayer(teamKey) {
            const container = document.getElementById(`team-${teamKey}-players`);
            const playerCount = container.children.length + 1;
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = `Professor ${playerCount} Name`;
            input.className = `w-full p-2 input-field player-input-${teamKey}`;
            container.appendChild(input);
            input.focus();
        }

        function handleSetupSubmit() {
            teams.a.name = document.getElementById('team-a-name').value || 'Team A';
            teams.b.name = document.getElementById('team-b-name').value || 'Team B';
            teams.a.players = Array.from(document.querySelectorAll('.player-input-a')).map(i => i.value).filter(Boolean);
            teams.b.players = Array.from(document.querySelectorAll('.player-input-b')).map(i => i.value).filter(Boolean);
            if (teams.a.players.length === 0 || teams.b.players.length === 0) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
                modal.innerHTML = `<div class="bg-slate-800 p-8 rounded-lg text-center shadow-lg"><p class="text-xl mb-4">Both teams need at least one player!</p><button class="bg-red-500 px-4 py-2 rounded">OK</button></div>`;
                document.body.appendChild(modal);
                modal.querySelector('button').onclick = () => modal.remove();
                return;
            }
            startGame();
        }

        // --- Tapping and Dragging Logic ---
        function handleTileClick(e) {
            const tile = this;
            const parent = tile.parentNode;
            if (parent.id === 'tiles-container') {
                const firstEmptyZone = Array.from(answerContainer.children).find(zone => !zone.hasChildNodes());
                if (firstEmptyZone) {
                    firstEmptyZone.appendChild(tile);
                    snapSound.triggerAttackRelease('C5', '16n', Tone.now());
                }
            } else { 
                tilesContainer.appendChild(tile);
                snapSound.triggerAttackRelease('A4', '16n', Tone.now());
            }
            checkWord();
        }
        function handleDragStart(e) { draggedTile=this; setTimeout(()=>this.classList.add('dragging'),0); e.dataTransfer.effectAllowed='move'; }
        function handleDragEnd() { this.classList.remove('dragging'); draggedTile=null; }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnter(e) { e.preventDefault(); this.classList.add('drag-over'); }
        function handleDragLeave() { this.classList.remove('drag-over'); }
        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            if (!draggedTile) return;
            const targetIsTile = this.classList.contains('letter-tile');
            const targetIsZone = this.classList.contains('drop-zone');
            if (targetIsZone && !this.hasChildNodes()) { this.appendChild(draggedTile); } 
            else if (targetIsTile) {
                const sourceContainer = draggedTile.parentNode;
                const targetContainer = this.parentNode;
                targetContainer.appendChild(draggedTile);
                sourceContainer.appendChild(this);
            } 
            else if (this.id === 'tiles-container') { this.appendChild(draggedTile); }
            
            snapSound.triggerAttackRelease('C5', '16n', Tone.now());
            checkWord();
        }

        // --- Game Flow ---
        function startGame() {
            setupSounds();
            currentWordIndex = 0; words = shuffleArray([...buildingNames]);
            teams.a.score = 0; teams.b.score = 0; currentTeamKey = 'a';
            switchScreen(setupScreen, gameScreen);
            document.getElementById('team-a-score-name').textContent = teams.a.name;
            document.getElementById('team-b-score-name').textContent = teams.b.name;
            updateScoreDisplay();
            loadNextWord();
        }

        function nextTurn() {
            currentTeamKey = currentTeamKey === 'a' ? 'b' : 'a';
            currentWordIndex++;
            loadNextWord();
        }

        function loadNextWord() {
            if (currentWordIndex >= words.length) { showScoreboard(); return; }
            updateProgressBar();
            currentWord = words[currentWordIndex].toUpperCase();
            const scrambledWord = shuffleString(currentWord);

            tilesContainer.innerHTML = ''; answerContainer.innerHTML = '';
            scrambledWord.split('').forEach(letter => {
                const tile = document.createElement('div');
                tile.className = 'letter-tile'; tile.textContent = letter; tile.draggable = true;
                tile.addEventListener('click', handleTileClick);
                tile.addEventListener('dragstart', handleDragStart);
                tile.addEventListener('dragend', handleDragEnd);
                tile.addEventListener('drop', handleDrop);
                tile.addEventListener('dragover', handleDragOver);
                tilesContainer.appendChild(tile);
            });
            for (let i = 0; i < currentWord.length; i++) {
                const dropZone = document.createElement('div');
                dropZone.className = 'drop-zone';
                dropZone.addEventListener('dragover', handleDragOver);
                dropZone.addEventListener('dragenter', handleDragEnter);
                dropZone.addEventListener('dragleave', handleDragLeave);
                dropZone.addEventListener('drop', handleDrop);
                answerContainer.appendChild(dropZone);
            }
            tilesContainer.addEventListener('dragover', handleDragOver);
            tilesContainer.addEventListener('drop', handleDrop);
            updateTurnIndicator();
            startTimer();
        }
        
        function checkWord() {
            const dropZones = Array.from(answerContainer.children);
            const allZonesFilled = dropZones.every(zone => zone.hasChildNodes());
            if (!allZonesFilled) return;

            const currentAttempt = dropZones.map(zone => zone.firstChild.textContent).join('');
            
            if (currentAttempt === currentWord) {
                clearInterval(timerInterval);
                teams[currentTeamKey].score += 10 + Math.floor(timeLeft / 10);
                updateScoreDisplay();
                dropZones.forEach(zone => zone.firstChild.classList.add('correct'));
                successSound.triggerAttackRelease('G5', '8n', Tone.now());
                setTimeout(nextTurn, 1500);
            } else {
                answerContainer.classList.add('shake');
                errorSound.triggerAttackRelease('C3', '8n', Tone.now());
                setTimeout(() => answerContainer.classList.remove('shake'), 500);
            }
        }
        
        function skipTurn() {
            passSound.triggerAttackRelease('A3', '4n', Tone.now());
            clearInterval(timerInterval);
            nextTurn();
        }

        function showScoreboard() {
            switchScreen(gameScreen, endScreen);
            const winner = teams.a.score > teams.b.score ? teams.a : (teams.b.score > teams.a.score ? teams.b : null);
            document.getElementById('winner-announcement').textContent = winner ? `${winner.name} Wins!` : "It's a Tie!";
            if (winner) {
                const winnerKey = winner === teams.a ? 'a' : 'b';
                document.querySelector('#end-screen .trophy-icon').className = `trophy-icon mb-4 ${winnerKey === 'a' ? 'text-green-400' : 'text-blue-400'}`;
            } else {
                 document.querySelector('#end-screen .trophy-icon').className = `trophy-icon mb-4 text-yellow-400`;
            }
            document.getElementById('final-team-a-name').textContent = teams.a.name;
            document.getElementById('final-team-a-score').textContent = teams.a.score;
            document.getElementById('final-team-a-players').innerHTML = teams.a.players.map(p => `<li class="bg-white/10 px-3 py-1 rounded-full text-sm text-slate-200">${p}</li>`).join('');
            document.getElementById('final-team-b-name').textContent = teams.b.name;
            document.getElementById('final-team-b-score').textContent = teams.b.score;
            document.getElementById('final-team-b-players').innerHTML = teams.b.players.map(p => `<li class="bg-white/10 px-3 py-1 rounded-full text-sm text-slate-200">${p}</li>`).join('');
            startConfetti();
            winSound.triggerAttackRelease(['C4', 'E4', 'G4', 'C5'], '2n', Tone.now());
        }
        
        function updateProgressBar() {
            const progress = (currentWordIndex / words.length) * 100;
            progressBar.style.width = `${progress}%`;
        }

        function updateScoreDisplay() {
            document.getElementById('team-a-score').textContent = teams.a.score;
            document.getElementById('team-b-score').textContent = teams.b.score;
        }

        function updateTurnIndicator() {
            document.getElementById('current-player-turn').textContent = `${teams[currentTeamKey].name}'s Turn`;
            const teamAdisplay = document.getElementById('team-a-score-display');
            const teamBdisplay = document.getElementById('team-b-score-display');
            if (currentTeamKey === 'a') {
                teamAdisplay.classList.add('team-a-active');
                teamBdisplay.classList.remove('team-b-active');
            } else {
                teamBdisplay.classList.add('team-b-active');
                teamAdisplay.classList.remove('team-a-active');
            }
        }
        
        const updateTimerDisplay = () => {
            if (timeLeft < 0) timeLeft = 0;
            const minutes = Math.floor(timeLeft/60).toString().padStart(2,'0');
            const seconds = (timeLeft%60).toString().padStart(2,'0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
        };

        function startTimer() {
            clearInterval(timerInterval);
            const totalTime = BASE_TIME + (currentWord.length * TIME_PER_LETTER);
            timeLeft = totalTime;
            hintButton.disabled = false;
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                if (timeLeft <= 0) {
                    errorSound.triggerAttackRelease('C3', '4n', Tone.now());
                    skipTurn();
                }
            }, 1000);
        }
        
        function showHint() {
            if (teams[currentTeamKey].score < HINT_COST) {
                hintButton.classList.add('shake');
                setTimeout(() => hintButton.classList.remove('shake'), 500);
                return;
            }
            teams[currentTeamKey].score -= HINT_COST;
            timeLeft -= HINT_TIME_PENALTY;
            updateTimerDisplay();
            updateScoreDisplay();

            const dropZones = Array.from(answerContainer.children);
            const incorrectIndices = [];
            dropZones.forEach((zone, i) => { if (!zone.hasChildNodes() || zone.firstChild.textContent !== currentWord[i]) { incorrectIndices.push(i); } });
            if (incorrectIndices.length === 0) { hintButton.disabled = true; return; }
            
            const shuffledIncorrectIndices = shuffleArray([...incorrectIndices]);
            const hintsToGive = Math.max(1, Math.floor(currentWord.length * 0.45));
            const indicesToCorrect = shuffledIncorrectIndices.slice(0, hintsToGive);

            indicesToCorrect.forEach(index => {
                const correctLetter = currentWord[index];
                const targetZone = dropZones[index];
                let tileToMove = Array.from(document.querySelectorAll('.letter-tile')).find(t => {
                    if (t.textContent !== correctLetter) return false;
                    const parent = t.parentNode;
                    return parent.id === 'tiles-container' || (parent.classList.contains('drop-zone') && currentWord[dropZones.indexOf(parent)] !== t.textContent);
                });
                if (!tileToMove) return;
                if (targetZone.hasChildNodes() && targetZone.firstChild !== tileToMove) { tilesContainer.appendChild(targetZone.firstChild); }
                targetZone.appendChild(tileToMove);
            });
            snapSound.triggerAttackRelease('A5', '8n', Tone.now());
            checkWord();
            hintButton.disabled = true;
        }

        function startConfetti() {
            const container = document.body;
            for (let i = 0; i < 150; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100+'vw'; c.style.animationDelay = Math.random()*3+'s';
                c.style.backgroundColor = `hsl(${Math.random()*360}, 90%, 60%)`;
                c.style.transform = `rotate(${Math.random()*360}deg)`;
                container.appendChild(c);
                setTimeout(()=>c.remove(), 5000);
            }
        }

        startGameButton.addEventListener('click', handleSetupSubmit);
        playAgainButton.addEventListener('click', () => switchScreen(endScreen, setupScreen));
        hintButton.addEventListener('click', showHint);
        skipButton.addEventListener('click', skipTurn);
    </script>
</body>
</html>


